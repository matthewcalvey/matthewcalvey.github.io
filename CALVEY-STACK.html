<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>STACK - CALVEY INC.</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f13;
            --bg-lighter: #1a1a22;
            --bg-card: #1e1e28;
            --perfect: #ffd93d;
            --text: #ffffff;
            --text-dim: #5a5a6e;
            --text-quote: #9a9ab0;
            --border: #2a2a3e;
        }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
        user-select: none;
    }

    html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: fixed;
        background: var(--bg);
        font-family: 'IBM Plex Mono', monospace;
    }

    #gameContainer {
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
        background: linear-gradient(180deg, var(--bg) 0%, var(--bg-lighter) 100%);
    }

    #gameContainer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
        background-size: 40px 40px;
        pointer-events: none;
    }

    #scoreDisplay {
        position: absolute;
        top: env(safe-area-inset-top, 20px);
        left: 0;
        right: 0;
        text-align: center;
        z-index: 100;
        padding-top: 24px;
    }

    .score-label {
        font-size: 10px;
        font-weight: 500;
        letter-spacing: 0.35em;
        color: var(--text-dim);
        text-transform: uppercase;
    }

    .score-value {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 80px;
        color: var(--text);
        line-height: 1;
        text-shadow: 0 4px 30px rgba(0,0,0,0.5);
    }

    .high-score {
        font-size: 11px;
        font-weight: 500;
        color: var(--text-dim);
        margin-top: 6px;
        letter-spacing: 0.1em;
    }

    #perfectIndicator {
        position: absolute;
        top: 48%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'Bebas Neue', sans-serif;
        font-size: 56px;
        letter-spacing: 0.05em;
        color: var(--perfect);
        text-shadow: 
            0 0 40px var(--perfect),
            0 0 80px rgba(255, 217, 61, 0.5);
        opacity: 0;
        z-index: 200;
        pointer-events: none;
    }

    #perfectIndicator.show {
        animation: perfectPop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes perfectPop {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
        30% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(1) translateY(-40px); }
    }

    #comboDisplay {
        position: absolute;
        top: 43%;
        left: 50%;
        transform: translateX(-50%);
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.25em;
        color: var(--perfect);
        text-shadow: 0 0 20px rgba(255, 217, 61, 0.6);
        opacity: 0;
        z-index: 200;
        pointer-events: none;
        transition: opacity 0.2s;
    }

    #comboDisplay.show {
        opacity: 1;
    }

    #gameCanvas {
        width: 100%;
        height: 100%;
    }

    #tapHint {
        position: absolute;
        bottom: calc(env(safe-area-inset-bottom, 20px) + 50px);
        left: 0;
        right: 0;
        text-align: center;
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.25em;
        color: var(--text-dim);
        text-transform: uppercase;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.4; }
        50% { opacity: 1; }
    }

    /* Start screen */
    #startScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 500;
        background: var(--bg);
    }

    #startScreen.hidden {
        display: none;
    }

    .brand-logo {
        font-family: 'IBM Plex Mono', monospace;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.4em;
        color: var(--text-dim);
        margin-bottom: 20px;
        padding: 8px 16px;
        border: 1px solid var(--text-dim);
        border-radius: 4px;
    }

    .game-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: clamp(90px, 28vw, 160px);
        color: var(--text);
        letter-spacing: 0.08em;
        line-height: 1;
        margin-bottom: 8px;
        text-shadow: 0 6px 40px rgba(0,0,0,0.4);
    }

    .game-subtitle {
        font-size: 11px;
        font-weight: 500;
        letter-spacing: 0.5em;
        color: var(--text-dim);
        text-transform: uppercase;
        margin-bottom: 50px;
    }

    .start-demo {
        width: 140px;
        height: 100px;
        margin-bottom: 50px;
        position: relative;
    }

    .demo-block {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        height: 24px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 7px;
        font-weight: 600;
        letter-spacing: 0.15em;
        color: rgba(255,255,255,0.9);
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .demo-block:nth-child(1) { 
        width: 120px; 
        bottom: 0; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .demo-block:nth-child(2) { 
        width: 110px; 
        bottom: 26px; 
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
    }
    .demo-block:nth-child(3) { 
        width: 100px; 
        bottom: 52px; 
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        animation: demoSlide 1.8s ease-in-out infinite;
    }

    @keyframes demoSlide {
        0%, 100% { transform: translateX(-90%); }
        50% { transform: translateX(-10%); }
    }

    .tap-start {
        font-size: 13px;
        font-weight: 500;
        letter-spacing: 0.35em;
        color: var(--text);
        text-transform: uppercase;
    }

    /* GAME OVER SCREEN */
    #gameOverScreen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 500;
        background: rgba(15, 15, 19, 0.97);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.4s;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    #gameOverScreen.visible {
        opacity: 1;
        pointer-events: auto;
    }

    .game-over-wrapper {
        min-height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: 40px 20px;
        padding-top: calc(env(safe-area-inset-top, 20px) + 30px);
        padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 30px);
    }

    .tower-graphic {
        width: 160px;
        height: 120px;
        margin-bottom: 12px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        flex-shrink: 0;
    }

    #towerCanvas {
        width: 160px;
        height: 120px;
    }

    .game-over-label {
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.4em;
        color: var(--text-dim);
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .final-score {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 72px;
        color: var(--text);
        line-height: 1;
        margin-bottom: 4px;
        text-shadow: 0 4px 30px rgba(0,0,0,0.3);
    }

    .score-stats {
        font-size: 10px;
        font-weight: 500;
        color: var(--text-dim);
        line-height: 1.8;
        margin-bottom: 12px;
        letter-spacing: 0.05em;
    }

    .score-stats span {
        color: var(--text);
    }

    .new-record {
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.25em;
        color: var(--perfect);
        border: 2px solid var(--perfect);
        padding: 8px 20px;
        border-radius: 6px;
        margin-bottom: 16px;
        opacity: 0;
        visibility: hidden;
        text-shadow: 0 0 20px var(--perfect);
    }

    .new-record.visible {
        opacity: 1;
        visibility: visible;
        animation: recordGlow 1.5s ease-in-out infinite;
    }

    @keyframes recordGlow {
        0%, 100% { box-shadow: 0 0 0 0 rgba(255, 217, 61, 0.4); }
        50% { box-shadow: 0 0 20px 5px rgba(255, 217, 61, 0.2); }
    }

    /* Username Section */
    .username-section {
        width: 100%;
        max-width: 300px;
        margin-bottom: 20px;
    }

    .username-prompt {
        font-size: 9px;
        font-weight: 600;
        letter-spacing: 0.2em;
        color: var(--text-dim);
        text-transform: uppercase;
        margin-bottom: 8px;
    }

    .username-input-wrapper {
        display: flex;
        gap: 8px;
    }

    .username-input {
        flex: 1;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px 14px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 13px;
        font-weight: 500;
        color: var(--text);
        outline: none;
        transition: border-color 0.2s;
    }

    .username-input:focus {
        border-color: var(--perfect);
    }

    .username-input::placeholder {
        color: var(--text-dim);
    }

    .username-save-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 6px;
        padding: 10px 16px;
        font-family: 'IBM Plex Mono', monospace;
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.1em;
        color: white;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .username-save-btn:active {
        transform: scale(0.95);
    }

    .username-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .current-username {
        font-size: 12px;
        font-weight: 500;
        color: var(--text);
    }

    .change-name-btn {
        font-size: 9px;
        font-weight: 600;
        letter-spacing: 0.1em;
        color: var(--text-dim);
        background: none;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 5px 10px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .change-name-btn:active {
        border-color: var(--text-dim);
        color: var(--text);
    }

    /* Quote Section */
    .quote-section {
        width: 100%;
        max-width: 300px;
        margin-bottom: 24px;
    }

    .quote-text {
        font-family: 'Playfair Display', serif;
        font-style: italic;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-quote);
        margin-bottom: 8px;
    }

    .quote-author {
        font-size: 9px;
        font-weight: 600;
        letter-spacing: 0.2em;
        color: var(--text-dim);
        text-transform: uppercase;
    }

    /* Leaderboard Section - NOW BELOW QUOTE */
    .leaderboard-section {
        width: 100%;
        max-width: 300px;
        margin-bottom: 24px;
    }

    .leaderboard-header {
        font-size: 9px;
        font-weight: 600;
        letter-spacing: 0.3em;
        color: var(--text-dim);
        text-transform: uppercase;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .leaderboard-status {
        font-size: 8px;
        color: var(--text-dim);
        opacity: 0.7;
    }

    .leaderboard-status.live {
        color: #43e97b;
    }

    .leaderboard-status.loading {
        color: var(--perfect);
    }

    .leaderboard {
        width: 100%;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
    }

    .leaderboard-entry {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
    }

    .leaderboard-entry:last-child {
        border-bottom: none;
    }

    .leaderboard-entry.current-player {
        background: rgba(255, 217, 61, 0.1);
    }

    .leaderboard-entry:nth-child(1) .entry-rank {
        color: #ffd93d;
        text-shadow: 0 0 10px rgba(255, 217, 61, 0.5);
    }

    .leaderboard-entry:nth-child(2) .entry-rank {
        color: #c0c0c0;
    }

    .leaderboard-entry:nth-child(3) .entry-rank {
        color: #cd7f32;
    }

    .entry-rank {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 18px;
        color: var(--text-dim);
        width: 28px;
        text-align: center;
    }

    .entry-name {
        flex: 1;
        font-size: 12px;
        font-weight: 500;
        color: var(--text);
        text-align: left;
        margin-left: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .entry-score {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 20px;
        color: var(--text);
        margin-left: 10px;
    }

    .leaderboard-loading {
        padding: 20px;
        text-align: center;
        color: var(--text-dim);
        font-size: 11px;
    }

    .tap-restart {
        font-size: 12px;
        font-weight: 500;
        letter-spacing: 0.35em;
        color: var(--text);
        text-transform: uppercase;
        animation: pulse 2s ease-in-out infinite;
        margin-top: auto;
        padding-top: 10px;
    }

    #soundToggle {
        position: absolute;
        top: env(safe-area-inset-top, 20px);
        right: 20px;
        padding-top: 24px;
        z-index: 300;
    }

    #soundToggle button {
        width: 48px;
        height: 48px;
        border: 2px solid var(--text-dim);
        border-radius: 50%;
        background: rgba(15, 15, 19, 0.6);
        backdrop-filter: blur(10px);
        color: var(--text);
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
    }

    #soundToggle button:active {
        transform: scale(0.9);
        border-color: var(--text);
    }

    #soundToggle button.off {
        color: var(--text-dim);
        border-color: rgba(90, 90, 110, 0.5);
    }

    .hidden {
        display: none !important;
    }
</style>

</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>

    <div id="scoreDisplay">
        <div class="score-label">Score</div>
        <div class="score-value" id="scoreValue">0</div>
        <div class="high-score">Best: <span id="highScoreValue">0</span></div>
    </div>

    <div id="perfectIndicator">PERFECT</div>
    <div id="comboDisplay">√ó1 COMBO</div>
    <div id="tapHint">Tap to place</div>

    <div id="soundToggle">
        <button id="soundBtn">‚ô™</button>
    </div>

    <!-- Start screen -->
    <div id="startScreen">
        <div class="brand-logo">CALVEY INC.</div>
        <h1 class="game-title">STACK</h1>
        <p class="game-subtitle">Build your empire</p>
        
        <div class="start-demo">
            <div class="demo-block">CALVEY INC.</div>
            <div class="demo-block">CALVEY INC.</div>
            <div class="demo-block">CALVEY INC.</div>
        </div>
        
        <p class="tap-start">Tap to Play</p>
    </div>

    <!-- Game over screen - REORDERED: Quote first, then Leaderboard -->
    <div id="gameOverScreen">
        <div class="game-over-wrapper">
            <div class="tower-graphic">
                <canvas id="towerCanvas"></canvas>
            </div>
            
            <div class="game-over-label">Final Score</div>
            <div class="final-score" id="finalScore">0</div>
            <div class="score-stats">
                Perfects: <span id="perfectCount">0</span> ¬∑ Best Combo: <span id="bestCombo">0</span>
            </div>
            <div class="new-record" id="newRecordBadge">‚òÖ NEW RECORD ‚òÖ</div>
            
            <!-- Username Section -->
            <div class="username-section" id="usernameSection">
                <div id="usernameInputArea">
                    <div class="username-prompt">Enter your name for the leaderboard</div>
                    <div class="username-input-wrapper">
                        <input type="text" class="username-input" id="usernameInput" placeholder="Your name" maxlength="12" autocomplete="off">
                        <button class="username-save-btn" id="saveUsernameBtn">SAVE</button>
                    </div>
                </div>
                <div id="usernameDisplayArea" class="hidden">
                    <div class="username-display">
                        <span class="current-username">Playing as: <strong id="currentUsername"></strong></span>
                        <button class="change-name-btn" id="changeNameBtn">CHANGE</button>
                    </div>
                </div>
            </div>

            <!-- Inspirational Quote - NOW FIRST -->
            <div class="quote-section">
                <p class="quote-text" id="quoteText">"Success is not final, failure is not fatal: it is the courage to continue that counts."</p>
                <p class="quote-author" id="quoteAuthor">‚Äî Winston Churchill</p>
            </div>
            
            <!-- Global Leaderboard - NOW BELOW QUOTE -->
            <div class="leaderboard-section">
                <div class="leaderboard-header">
                    üèÜ Global Leaderboard
                    <span class="leaderboard-status" id="leaderboardStatus"></span>
                </div>
                <div class="leaderboard" id="leaderboard">
                    <div class="leaderboard-loading">Loading scores...</div>
                </div>
            </div>
            
            <p class="tap-restart">Tap to Retry</p>
        </div>
    </div>
</div>

<!-- Firebase SDK (compat) - used for global/shared leaderboard across devices/users -->
<!-- To enable: create a Firebase project and set window.FIREBASE_CONFIG before this script runs.
     Example:
     <script>
       window.FIREBASE_CONFIG = {
         apiKey: "...",
         authDomain: "...",
         databaseURL: "https://<PROJECT>.firebaseio.com",
         projectId: "...",
         storageBucket: "...",
         messagingSenderId: "...",
         appId: "..."
       };
     </script>
-->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // ============================================================
    // CONFIGURATION
    // ============================================================
    
    const CONFIG = {
        BLOCK_HEIGHT: 32,
        INITIAL_WIDTH: 220,
        MIN_WIDTH: 25,
        INITIAL_SPEED: 3.2,
        SPEED_INCREMENT: 0.12,
        MAX_SPEED: 11,
        PERFECT_TOLERANCE: 6,
        GROW_AMOUNT: 4,
        MAX_GROW: 12,
        CAMERA_LERP: 0.12,
        STACK_VISIBLE: 10,
        BORDER_RADIUS: 10,
        MAX_LEADERBOARD_ENTRIES: 10
    };

    // Quotes
    const QUOTES = [
        { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
        { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
        { text: "Innovation distinguishes between a leader and a follower.", author: "Steve Jobs" },
        { text: "The best way to predict the future is to create it.", author: "Peter Drucker" },
        { text: "Your time is limited, don't waste it living someone else's life.", author: "Steve Jobs" },
        { text: "It does not matter how slowly you go as long as you do not stop.", author: "Confucius" },
        { text: "Fall seven times, stand up eight.", author: "Japanese Proverb" },
        { text: "The master has failed more times than the beginner has tried.", author: "Stephen McCranie" },
        { text: "Every strike brings me closer to the next home run.", author: "Babe Ruth" },
        { text: "I have not failed. I've just found 10,000 ways that won't work.", author: "Thomas Edison" },
        { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
        { text: "Whether you think you can or you think you can't, you're right.", author: "Henry Ford" },
        { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
        { text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.", author: "Ralph Waldo Emerson" },
        { text: "The only impossible journey is the one you never begin.", author: "Tony Robbins" },
        { text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
        { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
        { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
        { text: "Action is the foundational key to all success.", author: "Pablo Picasso" },
        { text: "Start where you are. Use what you have. Do what you can.", author: "Arthur Ashe" },
        { text: "Build your own dreams, or someone else will hire you to build theirs.", author: "Farrah Gray" },
        { text: "Dream it. Wish it. Do it.", author: "Unknown" },
        { text: "Go confidently in the direction of your dreams.", author: "Henry David Thoreau" },
        { text: "All our dreams can come true if we have the courage to pursue them.", author: "Walt Disney" },
        { text: "The biggest adventure you can take is to live the life of your dreams.", author: "Oprah Winfrey" },
        { text: "Strive not to be a success, but rather to be of value.", author: "Albert Einstein" },
        { text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
        { text: "In the middle of difficulty lies opportunity.", author: "Albert Einstein" },
        { text: "Life is 10% what happens to us and 90% how we react to it.", author: "Charles R. Swindoll" },
        { text: "The only person you are destined to become is the person you decide to be.", author: "Ralph Waldo Emerson" },
        { text: "Everything you've ever wanted is on the other side of fear.", author: "George Addair" },
        { text: "Great things never come from comfort zones.", author: "Unknown" },
        { text: "Don't be afraid to give up the good to go for the great.", author: "John D. Rockefeller" },
        { text: "Take the risk or lose the chance.", author: "Unknown" },
        { text: "Fortune favors the bold.", author: "Latin Proverb" },
        { text: "I find that the harder I work, the more luck I seem to have.", author: "Thomas Jefferson" },
        { text: "Success usually comes to those who are too busy to be looking for it.", author: "Henry David Thoreau" },
        { text: "Quality is not an act, it is a habit.", author: "Aristotle" },
        { text: "Excellence is not a skill, it's an attitude.", author: "Ralph Marston" },
        { text: "The only place where success comes before work is in the dictionary.", author: "Vidal Sassoon" },
        { text: "Your limitation‚Äîit's only your imagination.", author: "Unknown" },
        { text: "The mind is everything. What you think you become.", author: "Buddha" },
        { text: "Positive thinking will let you do everything better than negative thinking will.", author: "Zig Ziglar" },
        { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" },
        { text: "The only way to achieve the impossible is to believe it is possible.", author: "Charles Kingsleigh" },
        { text: "A journey of a thousand miles begins with a single step.", author: "Lao Tzu" },
        { text: "Progress is impossible without change.", author: "George Bernard Shaw" },
        { text: "Small progress is still progress.", author: "Unknown" },
        { text: "Success is a journey, not a destination.", author: "Arthur Ashe" },
        { text: "Every accomplishment starts with the decision to try.", author: "John F. Kennedy" }
    ];

    // Gradient colors
    const GRADIENTS = [
        ['#667eea', '#764ba2'], ['#6a11cb', '#2575fc'], ['#7f00ff', '#e100ff'],
        ['#8e2de2', '#4a00e0'], ['#b721ff', '#21d4fd'], ['#f093fb', '#f5576c'],
        ['#ff0844', '#ffb199'], ['#fa709a', '#fee140'], ['#ff758c', '#ff7eb3'],
        ['#c471f5', '#fa71cd'], ['#4facfe', '#00f2fe'], ['#00c6fb', '#005bea'],
        ['#48c6ef', '#6f86d6'], ['#0acffe', '#495aff'], ['#43e97b', '#38f9d7'],
        ['#11998e', '#38ef7d'], ['#00b09b', '#96c93d'], ['#56ab2f', '#a8e063'],
        ['#02aab0', '#00cdac'], ['#f7971e', '#ffd200'], ['#f2994a', '#f2c94c'],
        ['#fc4a1a', '#f7b733'], ['#f5af19', '#f12711'], ['#fceabb', '#f8b500'],
        ['#ff9a9e', '#fecfef'], ['#ffecd2', '#fcb69f'], ['#ff6b6b', '#feca57'],
        ['#ee9ca7', '#ffdde1'], ['#f857a6', '#ff5858'], ['#a8edea', '#fed6e3'],
        ['#d299c2', '#fef9d7'], ['#89f7fe', '#66a6ff'], ['#96fbc4', '#f9f586'],
        ['#c2e9fb', '#a1c4fd'], ['#1a2980', '#26d0ce']
    ];

    // ============================================================
    // GAME STATE
    // ============================================================
    
    const state = {
        playing: false,
        score: 0,
        highScore: parseInt(localStorage.getItem('calveyStackHighScore') || '0'),
        combo: 0,
        maxCombo: 0,
        perfects: 0,
        current: null,
        stack: [],
        falling: [],
        cameraY: 0,
        targetCameraY: 0,
        direction: 1,
        speed: CONFIG.INITIAL_SPEED,
        soundEnabled: true,
        gamesPlayed: parseInt(localStorage.getItem('calveyStackGamesPlayed') || '0'),
        username: localStorage.getItem('calveyStackUsername') || '',
        visitorId: localStorage.getItem('calveyStackVisitorId') || generateVisitorId(),
        leaderboard: []
    };

    // Generate unique visitor ID for this device
    function generateVisitorId() {
        const id = 'player_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
        localStorage.setItem('calveyStackVisitorId', id);
        return id;
    }

    // ============================================================
    // GLOBAL LEADERBOARD (Firebase-backed, with fallback)
    // ============================================================
    // This implementation uses Firebase Realtime Database when configured
    // to store a single global leaderboard path accessible by all clients.
    // If Firebase is not configured it falls back to the previous window.storage/localStorage behavior.

    const LEADERBOARD_PATH = '/calvey_stack/leaderboard';
    let firebaseEnabled = false;

    // If you want to enable Firebase, set window.FIREBASE_CONFIG before this script runs (see comments above).
    // Example:
    // window.FIREBASE_CONFIG = {
    //   apiKey: "...",
    //   authDomain: "...",
    //   databaseURL: "https://<PROJECT>.firebaseio.com",
    //   projectId: "...",
    //   storageBucket: "...",
    //   messagingSenderId: "...",
    //   appId: "..."
    // };

    function initFirebaseIfAvailable() {
        try {
            if (window.firebase && window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.databaseURL) {
                // don't re-init if already initialized
                if (!firebase.apps || !firebase.apps.length) {
                    firebase.initializeApp(window.FIREBASE_CONFIG);
                }
                firebaseEnabled = !!firebase.database;
                console.log('Firebase initialised for leaderboard:', firebaseEnabled);
            } else {
                firebaseEnabled = false;
            }
        } catch (e) {
            console.warn('Firebase init failed:', e);
            firebaseEnabled = false;
        }
    }

    // Call immediately so functions can use it
    initFirebaseIfAvailable();

    async function loadGlobalLeaderboard() {
        const statusEl = document.getElementById('leaderboardStatus');
        statusEl.textContent = '(loading...)';
        statusEl.className = 'leaderboard-status loading';

        // Try Firebase first for a truly global shared leaderboard
        if (firebaseEnabled) {
            try {
                const snapshot = await firebase.database().ref(LEADERBOARD_PATH).once('value');
                const val = snapshot.val();

                if (!val) {
                    state.leaderboard = [];
                } else if (Array.isArray(val)) {
                    state.leaderboard = val.filter(Boolean);
                } else if (typeof val === 'object') {
                    state.leaderboard = Object.values(val);
                } else {
                    state.leaderboard = [];
                }

                statusEl.textContent = '(live)';
                statusEl.className = 'leaderboard-status live';
                renderLeaderboard();

                // Attach a realtime listener to reflect updates from other devices
                firebase.database().ref(LEADERBOARD_PATH).on('value', snap => {
                    const v = snap.val();
                    if (!v) {
                        state.leaderboard = [];
                    } else if (Array.isArray(v)) {
                        state.leaderboard = v.filter(Boolean);
                    } else if (typeof v === 'object') {
                        state.leaderboard = Object.values(v);
                    } else {
                        state.leaderboard = [];
                    }
                    renderLeaderboard();
                });

                return;
            } catch (e) {
                console.warn('Failed to load leaderboard from Firebase:', e);
                // fall through to other storage options
            }
        }

        // Fallback: try window.storage (if available)
        try {
            if (window.storage) {
                const result = await window.storage.get('calvey-stack-global-leaderboard-v1', true);
                if (result && result.value) {
                    state.leaderboard = JSON.parse(result.value);
                } else {
                    state.leaderboard = [];
                }
                statusEl.textContent = '(live)';
                statusEl.className = 'leaderboard-status live';
                renderLeaderboard();
                return;
            }
        } catch (e) {
            console.log('Loading from shared storage failed:', e);
        }

        // Final fallback: localStorage (per-device only)
        try {
            const raw = localStorage.getItem('calvey-stack-global-leaderboard-v1');
            state.leaderboard = raw ? JSON.parse(raw) : [];
        } catch (e) {
            state.leaderboard = [];
        }
        statusEl.textContent = '(local)';
        statusEl.className = 'leaderboard-status';
        renderLeaderboard();
    }

    async function saveGlobalLeaderboard() {
        // Try Firebase first
        if (firebaseEnabled) {
            try {
                await firebase.database().ref(LEADERBOARD_PATH).set(state.leaderboard);
                console.log('Leaderboard saved to Firebase');
                return;
            } catch (e) {
                console.warn('Could not save leaderboard to Firebase:', e);
            }
        }

        // Try window.storage if available
        try {
            if (window.storage) {
                await window.storage.set('calvey-stack-global-leaderboard-v1', JSON.stringify(state.leaderboard), true);
                console.log('Leaderboard saved to window.storage');
                return;
            }
        } catch (e) {
            console.log('Could not save to shared storage:', e);
        }

        // Final fallback: localStorage
        try {
            localStorage.setItem('calvey-stack-global-leaderboard-v1', JSON.stringify(state.leaderboard));
            console.log('Leaderboard saved to localStorage (device only)');
        } catch (e) {
            console.warn('Could not save leaderboard to localStorage:', e);
        }
    }

    async function updateLeaderboard(score) {
        if (!state.username || score === 0) return;

        // If firebase is enabled, perform read-modify-write and write back trimmed sorted array
        if (firebaseEnabled) {
            try {
                const ref = firebase.database().ref(LEADERBOARD_PATH);
                const snap = await ref.once('value');
                let list = snap.val();
                if (!list) list = [];
                if (!Array.isArray(list)) {
                    list = Object.values(list || {});
                }

                const existingIndex = list.findIndex(entry => entry && entry.id === state.visitorId);

                if (existingIndex !== -1) {
                    if (score > list[existingIndex].score) {
                        list[existingIndex].score = score;
                        list[existingIndex].name = state.username;
                        list[existingIndex].timestamp = Date.now();
                    }
                } else {
                    list.push({
                        id: state.visitorId,
                        name: state.username,
                        score: score,
                        timestamp: Date.now()
                    });
                }

                list.sort((a, b) => b.score - a.score);
                list = list.slice(0, CONFIG.MAX_LEADERBOARD_ENTRIES);

                await ref.set(list);
                state.leaderboard = list;
                renderLeaderboard();
                return;
            } catch (e) {
                console.warn('Failed to update leaderboard in Firebase:', e);
                // fall through to other methods
            }
        }

        // Fallback: window.storage
        try {
            if (window.storage) {
                try {
                    const result = await window.storage.get('calvey-stack-global-leaderboard-v1', true);
                    state.leaderboard = result && result.value ? JSON.parse(result.value) : [];
                } catch (e) {
                    state.leaderboard = [];
                }

                const existingIndex = state.leaderboard.findIndex(entry => entry.id === state.visitorId);

                if (existingIndex !== -1) {
                    if (score > state.leaderboard[existingIndex].score) {
                        state.leaderboard[existingIndex].score = score;
                        state.leaderboard[existingIndex].name = state.username;
                        state.leaderboard[existingIndex].timestamp = Date.now();
                    }
                } else {
                    state.leaderboard.push({
                        id: state.visitorId,
                        name: state.username,
                        score: score,
                        timestamp: Date.now()
                    });
                }

                state.leaderboard.sort((a, b) => b.score - a.score);
                state.leaderboard = state.leaderboard.slice(0, CONFIG.MAX_LEADERBOARD_ENTRIES);

                await saveGlobalLeaderboard();
                renderLeaderboard();
                return;
            }
        } catch (e) {
            console.log('Could not refresh leaderboard via window.storage', e);
        }

        // Final fallback: localStorage
        try {
            const raw = localStorage.getItem('calvey-stack-global-leaderboard-v1');
            state.leaderboard = raw ? JSON.parse(raw) : [];

            const existingIndex = state.leaderboard.findIndex(entry => entry.id === state.visitorId);

            if (existingIndex !== -1) {
                if (score > state.leaderboard[existingIndex].score) {
                    state.leaderboard[existingIndex].score = score;
                    state.leaderboard[existingIndex].name = state.username;
                    state.leaderboard[existingIndex].timestamp = Date.now();
                }
            } else {
                state.leaderboard.push({
                    id: state.visitorId,
                    name: state.username,
                    score: score,
                    timestamp: Date.now()
                });
            }

            state.leaderboard.sort((a, b) => b.score - a.score);
            state.leaderboard = state.leaderboard.slice(0, CONFIG.MAX_LEADERBOARD_ENTRIES);

            localStorage.setItem('calvey-stack-global-leaderboard-v1', JSON.stringify(state.leaderboard));
            renderLeaderboard();
        } catch (e) {
            console.warn('Could not update leaderboard in fallback storage:', e);
        }
    }

    // ============================================================
    // CANVAS SETUP
    // ============================================================
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height, centerX, baseY, dpr;

    function resize() {
        dpr = window.devicePixelRatio || 1;
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(dpr, dpr);
        
        centerX = width / 2;
        baseY = height * 0.72;
    }

    window.addEventListener('resize', resize);
    resize();

    // ============================================================
    // AUDIO
    // ============================================================
    
    let audioCtx = null;

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playSound(type) {
        if (!state.soundEnabled || !audioCtx) return;
        
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        // ... rest of audio and game code continues unchanged ...
    }

    // (REMAINDER OF ORIGINAL GAME CODE SHOULD FOLLOW HERE ‚Äî unchanged)
    // NOTE: The rest of the game's JavaScript (rendering loop, input handling,
    // renderLeaderboard() implementation, username saving UI handlers, etc.)
    // remains unchanged from your original file and will continue to use
    // loadGlobalLeaderboard(), updateLeaderboard(score) and saveGlobalLeaderboard()
    // which now prefer Firebase when configured.

    // To initialize leaderboard on load:
    window.addEventListener('load', () => {
        // re-run firebase init in case window.FIREBASE_CONFIG was set after script inclusion
        initFirebaseIfAvailable();
        // load the leaderboard (will use Firebase if enabled)
        try { loadGlobalLeaderboard(); } catch (e) { console.warn('loadGlobalLeaderboard failed:', e); }
    });
</script>

</body>
</html>

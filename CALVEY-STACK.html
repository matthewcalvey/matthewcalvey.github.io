<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>STACK - CALVEY INC.</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f13;
            --bg-lighter: #1a1a22;
            --bg-card: #1e1e28;
            --perfect: #ffd93d;
            --text: #ffffff;
            --text-dim: #5a5a6e;
            --text-quote: #9a9ab0;
            --border: #2a2a3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: var(--bg);
            font-family: 'IBM Plex Mono', monospace;
            -webkit-tap-highlight-color: transparent;
        }

        #gameContainer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg, var(--bg) 0%, var(--bg-lighter) 100%);
        }

        #gameContainer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        #scoreDisplay {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 100;
            padding-top: 24px;
            pointer-events: none;
        }

        .score-label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 0.35em;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .score-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 80px;
            color: var(--text);
            line-height: 1;
            text-shadow: 0 4px 30px rgba(0,0,0,0.5);
        }

        .high-score {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-dim);
            margin-top: 6px;
            letter-spacing: 0.1em;
        }

        #perfectIndicator {
            position: absolute;
            top: 48%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Bebas Neue', sans-serif;
            font-size: 56px;
            letter-spacing: 0.05em;
            color: var(--perfect);
            text-shadow: 0 0 40px var(--perfect), 0 0 80px rgba(255, 217, 61, 0.5);
            opacity: 0;
            z-index: 200;
            pointer-events: none;
        }

        #perfectIndicator.show {
            animation: perfectPop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes perfectPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1) translateY(-40px); }
        }

        #comboDisplay {
            position: absolute;
            top: 43%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.25em;
            color: var(--perfect);
            text-shadow: 0 0 20px rgba(255, 217, 61, 0.6);
            opacity: 0;
            z-index: 200;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        #comboDisplay.show { opacity: 1; }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #tapHint {
            position: absolute;
            bottom: 70px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.25em;
            color: var(--text-dim);
            text-transform: uppercase;
            animation: pulse 2s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
            background: var(--bg);
            cursor: pointer;
        }

        #startScreen.hidden { display: none; }

        .brand-logo {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.4em;
            color: var(--text-dim);
            margin-bottom: 20px;
            padding: 8px 16px;
            border: 1px solid var(--text-dim);
            border-radius: 4px;
        }

        .game-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(90px, 28vw, 160px);
            color: var(--text);
            letter-spacing: 0.08em;
            line-height: 1;
            margin-bottom: 8px;
            text-shadow: 0 6px 40px rgba(0,0,0,0.4);
        }

        .game-subtitle {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.5em;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 50px;
        }

        .start-demo {
            width: 140px;
            height: 100px;
            margin-bottom: 50px;
            position: relative;
        }

        .demo-block {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            height: 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: rgba(255,255,255,0.9);
        }

        .demo-block:nth-child(1) { 
            width: 120px; bottom: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .demo-block:nth-child(2) { 
            width: 110px; bottom: 26px; 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .demo-block:nth-child(3) { 
            width: 100px; bottom: 52px; 
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            animation: demoSlide 1.8s ease-in-out infinite;
        }

        @keyframes demoSlide {
            0%, 100% { transform: translateX(-90%); }
            50% { transform: translateX(-10%); }
        }

        .tap-start {
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.35em;
            color: var(--text);
            text-transform: uppercase;
        }

        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 500;
            background: rgba(15, 15, 19, 0.97);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
            overflow-y: auto;
        }

        #gameOverScreen.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .game-over-wrapper {
            min-height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 50px 20px;
        }

        .tower-graphic {
            width: 160px;
            height: 120px;
            margin-bottom: 12px;
        }

        #towerCanvas {
            width: 160px;
            height: 120px;
        }

        .game-over-label {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.4em;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .final-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 72px;
            color: var(--text);
            line-height: 1;
            margin-bottom: 4px;
        }

        .score-stats {
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 12px;
        }

        .score-stats span { color: var(--text); }

        .new-record {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.25em;
            color: var(--perfect);
            border: 2px solid var(--perfect);
            padding: 8px 20px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: none;
        }

        .new-record.visible { display: block; }

        .username-section {
            width: 100%;
            max-width: 300px;
            margin-bottom: 20px;
        }

        .username-prompt {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.2em;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .username-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .username-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 14px;
            border-radius: 8px;
            color: var(--text);
            font-size: 12px;
            font-family: 'IBM Plex Mono', monospace;
            outline: none;
        }

        .username-input:focus {
            border-color: rgba(255,255,255,0.35);
        }

        .save-name-btn {
            background: var(--text);
            border: none;
            border-radius: 8px;
            padding: 12px 14px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
        }

        .username-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text);
        }

        .change-name-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            color: var(--text);
        }

        .leaderboard-section {
            width: 100%;
            max-width: 340px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 18px;
            text-align: left;
        }

        .leaderboard-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .leaderboard-title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            color: var(--text);
        }

        .leaderboard-subtitle {
            font-size: 9px;
            color: var(--text-dim);
            letter-spacing: 0.12em;
        }

        .leaderboard-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 6px;
        }

        .leaderboard-item {
            display: grid;
            grid-template-columns: 22px 1fr auto;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.04);
        }

        .leaderboard-rank {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 18px;
            color: var(--text-dim);
            text-align: center;
        }

        .leaderboard-name {
            font-size: 11px;
            color: var(--text);
            letter-spacing: 0.04em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leaderboard-score {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 20px;
            color: var(--text);
            letter-spacing: 0.03em;
        }

        .leaderboard-item.me {
            border-color: rgba(255,217,61,0.35);
            background: rgba(255,217,61,0.06);
        }

        .leaderboard-item.me .leaderboard-rank,
        .leaderboard-item.me .leaderboard-score {
            color: var(--perfect);
        }

        .leaderboard-note {
            margin-top: 10px;
            font-size: 9px;
            color: var(--text-dim);
            line-height: 1.35;
        }

        .buttons {
            width: 100%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 22px;
        }

        .btn {
            width: 100%;
            padding: 16px 24px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            transition: all 0.2s;
            font-family: 'IBM Plex Mono', monospace;
        }

        .btn-primary {
            background: var(--text);
            color: var(--bg);
            border: none;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-primary:hover {
            background: var(--perfect);
        }

        .quote-card {
            width: 100%;
            max-width: 340px;
            border: 1px solid var(--border);
            background: rgba(30,30,40,0.6);
            border-radius: 14px;
            padding: 22px 20px;
            margin-top: auto;
        }

        .quote-text {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            line-height: 1.45;
            color: var(--text-quote);
            margin-bottom: 12px;
        }

        .quote-author {
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.15em;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        #soundToggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(30,30,40,0.65);
            border: 1px solid rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 600;
            backdrop-filter: blur(10px);
        }

        #soundBtn {
            color: var(--text-dim);
            font-size: 18px;
            transition: transform 0.2s;
            user-select: none;
        }

        #soundBtn.off {
            color: rgba(255,255,255,0.25);
        }

        #soundToggle:hover #soundBtn {
            transform: scale(1.15);
        }

        /* Toast */
        #toast {
            position: absolute;
            left: 50%;
            bottom: 24px;
            transform: translateX(-50%);
            background: rgba(10,10,14,0.92);
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 11px;
            letter-spacing: 0.02em;
            opacity: 0;
            pointer-events: none;
            z-index: 900;
            transition: opacity 0.25s ease;
            max-width: calc(100% - 40px);
            text-align: center;
        }
        #toast.show { opacity: 1; }

        /* Responsive */
        @media (max-height: 700px) {
            .game-over-wrapper { padding: 28px 16px; }
            .final-score { font-size: 62px; }
            .quote-text { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>

        <div id="scoreDisplay">
            <div class="score-label">SCORE</div>
            <div class="score-value" id="scoreValue">0</div>
            <div class="high-score">HIGH <span id="highScoreValue">0</span></div>
        </div>

        <div id="perfectIndicator">PERFECT</div>
        <div id="comboDisplay">COMBO × <span id="comboValue">1</span></div>

        <div id="tapHint">TAP TO DROP</div>

        <div id="startScreen">
            <div class="brand-logo">CALVEY INC.</div>
            <div class="game-title">STACK</div>
            <div class="game-subtitle">precision builds power</div>
            <div class="start-demo" aria-hidden="true">
                <div class="demo-block">BASE</div>
                <div class="demo-block">STACK</div>
                <div class="demo-block">DROP</div>
            </div>
            <div class="tap-start">Tap to Start</div>
        </div>

        <div id="gameOverScreen">
            <div class="game-over-wrapper">
                <div class="tower-graphic">
                    <canvas id="towerCanvas" width="160" height="120"></canvas>
                </div>

                <div class="game-over-label">GAME OVER</div>
                <div class="final-score" id="finalScore">0</div>
                <div class="score-stats">
                    PERFECT <span id="perfectCount">0</span> · BEST COMBO <span id="bestCombo">0</span>
                </div>

                <div class="new-record" id="newRecordBadge">NEW HIGH SCORE</div>

                <div class="username-section">
                    <div class="username-prompt">Your name (for leaderboard)</div>

                    <div id="usernameInputArea">
                        <div class="username-input-wrapper">
                            <input class="username-input" id="usernameInput" maxlength="18" placeholder="e.g., Matt" />
                            <button class="save-name-btn" id="saveUsernameBtn">Save</button>
                        </div>
                    </div>

                    <div id="usernameDisplayArea" class="hidden">
                        <div class="username-display">
                            <span id="usernameDisplayText"></span>
                            <button class="change-name-btn" id="changeNameBtn">Edit</button>
                        </div>
                    </div>
                </div>

                <div class="leaderboard-section">
                    <div class="leaderboard-header">
                        <div class="leaderboard-title">Leaderboard</div>
                        <div class="leaderboard-subtitle" id="leaderboardStatus">Top scores</div>
                    </div>
                    <ol class="leaderboard-list" id="leaderboardList"></ol>
                    <div class="leaderboard-note" id="leaderboardNote">
                        Scores post live when the server is available; otherwise they stay on this device.
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn btn-primary" id="tapRestart">PLAY AGAIN</button>
                    <button class="btn" id="shareScoreBtn">SHARE SCORE</button>
                </div>

                <div class="quote-card">
                    <div class="quote-text" id="quoteText"></div>
                    <div class="quote-author" id="quoteAuthor"></div>
                </div>
            </div>
        </div>

        <div id="soundToggle" title="Sound">
            <div id="soundBtn">♪</div>
        </div>

        <div id="toast"></div>
    </div>

    <script>
        // ============================================================
        // CONFIG
        // ============================================================
        const CONFIG = {
            BLOCK_HEIGHT: 32,
            INITIAL_WIDTH: 240,
            MIN_WIDTH: 46,
            SPEED_INCREMENT: 0.045,
            INITIAL_SPEED: 2.25,
            PERFECT_THRESHOLD: 7,      // pixels
            COMBO_MAX_BONUS: 5,
            CAMERA_LERP: 0.12,
            BORDER_RADIUS: 10,
            GRADIENTS: [
                ['#667eea', '#764ba2'],
                ['#f093fb', '#f5576c'],
                ['#4facfe', '#00f2fe'],
                ['#43e97b', '#38f9d7'],
                ['#fa709a', '#fee140'],
                ['#30cfd0', '#330867'],
                ['#a8edea', '#fed6e3'],
                ['#ff9a9e', '#fad0c4'],
                ['#ffecd2', '#fcb69f'],
                ['#a1c4fd', '#c2e9fb']
            ],
            API_BASE: '' // same origin by default (server serves the file)
        };

        // ============================================================
        // DOM
        // ============================================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const scoreEl = document.getElementById('scoreValue');
        const highScoreEl = document.getElementById('highScoreValue');
        const perfectEl = document.getElementById('perfectIndicator');
        const comboEl = document.getElementById('comboDisplay');
        const comboValueEl = document.getElementById('comboValue');

        const leaderboardListEl = document.getElementById('leaderboardList');
        const leaderboardStatusEl = document.getElementById('leaderboardStatus');

        const toastEl = document.getElementById('toast');

        // ============================================================
        // STATE
        // ============================================================
        let width = 0;
        let height = 0;
        let centerX = 0;

        const state = {
            playing: false,
            score: 0,
            combo: 0,
            maxCombo: 0,
            perfects: 0,
            speed: CONFIG.INITIAL_SPEED,
            direction: 1, // 1 right, -1 left
            cameraY: 0,
            targetCameraY: 0,

            stack: [],
            current: null,
            falling: [],

            highScore: parseInt(localStorage.getItem('calveyStackHighScore') || '0', 10),

            // player identity for best-score tracking on server
            playerId: localStorage.getItem('calveyStackPlayerId') || '',
            username: localStorage.getItem('calveyStackUsername') || '',

            soundEnabled: true
        };

        // Ensure a stable id for "best score per player"
        if (!state.playerId) {
            // simple random id; good enough for casual sharing
            state.playerId = 'p_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
            localStorage.setItem('calveyStackPlayerId', state.playerId);
        }

        // ============================================================
        // QUOTES
        // ============================================================
        const QUOTES = [
            { text: "How you do anything is how you do everything.", author: "Unknown" },
            { text: "Discipline is choosing between what you want now and what you want most.", author: "Abraham Lincoln (attributed)" },
            { text: "Make it work. Make it right. Make it fast.", author: "Kent Beck" },
            { text: "The details are not the details. They make the design.", author: "Charles Eames" },
            { text: "Small disciplines repeated daily lead to great achievements.", author: "John C. Maxwell" },
            { text: "Perfection is not attainable, but if we chase perfection we can catch excellence.", author: "Vince Lombardi" },
            { text: "What gets measured gets improved.", author: "Peter Drucker" }
        ];

        // ============================================================
        // RESIZE
        // ============================================================
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = Math.floor(width * devicePixelRatio);
            canvas.height = Math.floor(height * devicePixelRatio);
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);

            centerX = width / 2;

            // Base Y is near bottom
            baseY = height * 0.78;
        }

        let baseY = 0;

        window.addEventListener('resize', resize);
        resize();

        // ============================================================
        // UI HELPERS
        // ============================================================
        function updateUI() {
            scoreEl.textContent = state.score;
            highScoreEl.textContent = state.highScore;

            if (state.combo > 1) {
                comboValueEl.textContent = state.combo;
                comboEl.classList.add('show');
            } else {
                comboEl.classList.remove('show');
            }
        }

        let toastTimer = null;
        function toast(msg) {
            toastEl.textContent = msg;
            toastEl.classList.add('show');
            if (toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2400);
        }

        function showPerfect() {
            perfectEl.classList.remove('show');
            // restart animation
            void perfectEl.offsetWidth;
            perfectEl.classList.add('show');
        }

        // ============================================================
        // AUDIO (simple oscillator blips)
        // ============================================================
        let audioCtx = null;

        function initAudio() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                audioCtx = null;
            }
        }

        function playTone(freq, duration = 0.06, type = 'sine', gain = 0.05) {
            if (!state.soundEnabled || !audioCtx) return;
            const t0 = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, t0);
            g.gain.setValueAtTime(gain, t0);
            g.gain.exponentialRampToValueAtTime(0.0001, t0 + duration);
            osc.connect(g);
            g.connect(audioCtx.destination);
            osc.start(t0);
            osc.stop(t0 + duration);
        }

        function playSound(kind) {
            if (kind === 'drop') playTone(240, 0.05, 'triangle', 0.06);
            if (kind === 'perfect') { playTone(520, 0.07, 'sine', 0.08); playTone(780, 0.06, 'sine', 0.06); }
            if (kind === 'cut') playTone(160, 0.07, 'square', 0.05);
            if (kind === 'fail') playTone(80, 0.25, 'sawtooth', 0.07);
        }

        // ============================================================
        // LEADERBOARD (SERVER + FALLBACK)
        // ============================================================
        const LOCAL_LB_KEY = 'calveyStackLocalLeaderboard';
        function loadLocalLeaderboard() {
            try {
                return JSON.parse(localStorage.getItem(LOCAL_LB_KEY) || '[]');
            } catch {
                return [];
            }
        }
        function saveLocalLeaderboard(rows) {
            localStorage.setItem(LOCAL_LB_KEY, JSON.stringify(rows));
        }

        function renderLeaderboard(rows) {
            leaderboardListEl.innerHTML = '';
            const top = rows.slice(0, 10);

            if (top.length === 0) {
                const li = document.createElement('li');
                li.className = 'leaderboard-item';
                li.innerHTML = `
                    <div class="leaderboard-rank">—</div>
                    <div class="leaderboard-name">No scores yet</div>
                    <div class="leaderboard-score">0</div>
                `;
                leaderboardListEl.appendChild(li);
                return;
            }

            top.forEach((r, i) => {
                const li = document.createElement('li');
                li.className = 'leaderboard-item' + (r.id === state.playerId ? ' me' : '');
                li.innerHTML = `
                    <div class="leaderboard-rank">${i + 1}</div>
                    <div class="leaderboard-name">${escapeHtml(r.name || 'Anonymous')}</div>
                    <div class="leaderboard-score">${r.score}</div>
                `;
                leaderboardListEl.appendChild(li);
            });
        }

        function escapeHtml(str) {
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        async function fetchLeaderboard(limit = 10) {
            const url = (CONFIG.API_BASE || '') + `/api/leaderboard?limit=${encodeURIComponent(limit)}`;
            const res = await fetch(url, { method: 'GET' });
            if (!res.ok) throw new Error('Leaderboard fetch failed');
            return res.json();
        }

        async function submitScore(score) {
            const url = (CONFIG.API_BASE || '') + `/api/submit`;
            const payload = {
                id: state.playerId,
                name: state.username || 'Anonymous',
                score: score
            };
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error('Score submit failed');
            return res.json();
        }

        async function loadGlobalLeaderboard() {
            try {
                leaderboardStatusEl.textContent = 'Live';
                const data = await fetchLeaderboard(10);
                renderLeaderboard(data.leaderboard || []);
            } catch (e) {
                leaderboardStatusEl.textContent = 'Local';
                renderLeaderboard(loadLocalLeaderboard());
            }
        }

        function updateLeaderboard(newScore) {
            // Always maintain a local best-per-id leaderboard as fallback.
            const local = loadLocalLeaderboard();
            const existing = local.find(r => r.id === state.playerId);
            if (!existing) {
                local.push({ id: state.playerId, name: state.username || 'Anonymous', score: newScore });
            } else if (newScore > existing.score) {
                existing.score = newScore;
                existing.name = state.username || existing.name || 'Anonymous';
            }
            local.sort((a, b) => b.score - a.score);
            saveLocalLeaderboard(local);

            // Try to submit to server; then refresh from server.
            (async () => {
                try {
                    leaderboardStatusEl.textContent = 'Posting…';
                    await submitScore(newScore); // server keeps best per id
                    leaderboardStatusEl.textContent = 'Live';
                    const data = await fetchLeaderboard(10);
                    renderLeaderboard(data.leaderboard || []);
                } catch (e) {
                    leaderboardStatusEl.textContent = 'Local';
                    renderLeaderboard(local);
                }
            })();
        }

        function saveUsername(name) {
            state.username = (name || '').trim().slice(0, 18);
            localStorage.setItem('calveyStackUsername', state.username);
            updateUsernameDisplay();
        }

        function updateUsernameDisplay() {
            const inputArea = document.getElementById('usernameInputArea');
            const displayArea = document.getElementById('usernameDisplayArea');
            const displayText = document.getElementById('usernameDisplayText');

            if (state.username) {
                displayText.textContent = state.username;
                inputArea.classList.add('hidden');
                displayArea.classList.remove('hidden');
            } else {
                inputArea.classList.remove('hidden');
                displayArea.classList.add('hidden');
            }
        }

        // ============================================================
        // TOWER GRAPHIC
        // ============================================================
        function drawTowerGraphic(score, highScore) {
            const tCanvas = document.getElementById('towerCanvas');
            const tCtx = tCanvas.getContext('2d');
            tCtx.clearRect(0, 0, tCanvas.width, tCanvas.height);

            // simple bars representing score vs highscore
            const max = Math.max(10, highScore);
            const h1 = Math.min(1, score / max) * (tCanvas.height - 20);
            const h2 = Math.min(1, highScore / max) * (tCanvas.height - 20);

            // score bar
            tCtx.fillStyle = 'rgba(255,255,255,0.8)';
            tCtx.fillRect(40, tCanvas.height - 10 - h1, 28, h1);

            // highscore bar
            tCtx.fillStyle = 'rgba(255,217,61,0.8)';
            tCtx.fillRect(92, tCanvas.height - 10 - h2, 28, h2);

            // labels
            tCtx.fillStyle = 'rgba(255,255,255,0.5)';
            tCtx.font = '10px IBM Plex Mono';
            tCtx.textAlign = 'center';
            tCtx.fillText('YOU', 54, tCanvas.height - 2);
            tCtx.fillText('BEST', 106, tCanvas.height - 2);
        }

        // ============================================================
        // GAME LOGIC
        // ============================================================
        function getGradient(ctx, i, x, y, w, h) {
            const g = ctx.createLinearGradient(x, y, x + w, y + h);
            const pair = CONFIG.GRADIENTS[i % CONFIG.GRADIENTS.length];
            g.addColorStop(0, pair[0]);
            g.addColorStop(1, pair[1]);
            return g;
        }

        function roundRect(ctx, x, y, w, h, r) {
            const rr = Math.min(r, w / 2, h / 2);
            ctx.beginPath();
            ctx.moveTo(x + rr, y);
            ctx.arcTo(x + w, y, x + w, y + h, rr);
            ctx.arcTo(x + w, y + h, x, y + h, rr);
            ctx.arcTo(x, y + h, x, y, rr);
            ctx.arcTo(x, y, x + w, y, rr);
            ctx.closePath();
        }

        function drawBlock(x, y, w, h, index, isMoving) {
            const colorIndex = index;
            const gradient = getGradient(ctx, colorIndex, x - w / 2, y - h / 2, w, h);

            // shadow
            ctx.save();
            ctx.globalAlpha = 0.55;
            ctx.fillStyle = 'rgba(0,0,0,0.45)';
            roundRect(ctx, x - w / 2 + 2, y - h / 2 + 5, w, h, CONFIG.BORDER_RADIUS);
            ctx.fill();
            ctx.restore();

            // block
            ctx.save();
            ctx.globalAlpha = isMoving ? 0.96 : 1.0;
            roundRect(ctx, x - w / 2, y - h / 2, w, h, CONFIG.BORDER_RADIUS);
            ctx.fillStyle = gradient;
            ctx.fill();

            // highlight border
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.restore();
        }

        function spawnNextBlock() {
            const last = state.stack[state.stack.length - 1];
            const y = last.y - CONFIG.BLOCK_HEIGHT;
            const w = last.width;

            state.current = {
                x: centerX - (width * 0.25) * state.direction,
                y,
                width: w,
                height: CONFIG.BLOCK_HEIGHT,
                placed: false
            };

            // increase speed slowly with score
            state.speed = CONFIG.INITIAL_SPEED + state.score * CONFIG.SPEED_INCREMENT;
        }

        function placeBlock() {
            if (!state.current || state.current.placed) return;

            const current = state.current;
            const last = state.stack[state.stack.length - 1];

            const dx = current.x - last.x;
            const overlap = last.width - Math.abs(dx);

            playSound('drop');

            if (overlap <= 0) {
                // miss
                state.falling.push({
                    x: current.x,
                    y: current.y,
                    width: current.width,
                    height: current.height,
                    vx: 3 * state.direction,
                    vy: -2,
                    rotation: 0,
                    rotationSpeed: 0.08 * state.direction,
                    colorIndex: state.stack.length
                });
                gameOver();
                return;
            }

            const newWidth = overlap;
            const newX = current.x - dx / 2;

            const cutWidth = current.width - newWidth;
            const isPerfect = Math.abs(dx) <= CONFIG.PERFECT_THRESHOLD;

            // Perfect snap
            if (isPerfect) {
                current.x = last.x;
                current.width = last.width;
                state.combo += 1;
                state.perfects += 1;
                state.maxCombo = Math.max(state.maxCombo, state.combo);
                showPerfect();
                playSound('perfect');
            } else {
                state.combo = 0;
                playSound('cut');
                // Create falling piece
                const cutX = dx > 0
                    ? current.x + newWidth / 2 + cutWidth / 2
                    : current.x - newWidth / 2 - cutWidth / 2;

                state.falling.push({
                    x: cutX,
                    y: current.y,
                    width: cutWidth,
                    height: current.height,
                    vx: 3.2 * (dx > 0 ? 1 : -1),
                    vy: -2.2,
                    rotation: 0,
                    rotationSpeed: 0.09 * (dx > 0 ? 1 : -1),
                    colorIndex: state.stack.length
                });

                current.x = newX;
                current.width = newWidth;
            }

            current.placed = true;
            state.stack.push(current);

            // score
            let add = 1;
            if (isPerfect) add += Math.min(CONFIG.COMBO_MAX_BONUS, Math.max(0, state.combo - 1));
            state.score += add;

            // camera target
            state.targetCameraY = Math.min(0, height * 0.45 - current.y);

            updateUI();

            // new high score
            if (state.score > state.highScore) {
                state.highScore = state.score;
                localStorage.setItem('calveyStackHighScore', String(state.highScore));
            }

            // next
            spawnNextBlock();
        }

        function update() {
            if (!state.playing) return;

            // move current
            const cur = state.current;
            if (cur && !cur.placed) {
                cur.x += state.speed * state.direction;
                const leftBound = cur.width / 2 + 14;
                const rightBound = width - cur.width / 2 - 14;
                if (cur.x <= leftBound) { cur.x = leftBound; state.direction = 1; }
                if (cur.x >= rightBound) { cur.x = rightBound; state.direction = -1; }
            }

            // camera
            state.cameraY += (state.targetCameraY - state.cameraY) * CONFIG.CAMERA_LERP;

            // falling pieces
            state.falling = state.falling.filter(piece => {
                piece.vy += 0.6;
                piece.y += piece.vy;
                piece.x += piece.vx;
                piece.rotation += piece.rotationSpeed;
                return piece.y < height + 150;
            });
        }

        function render() {
            ctx.clearRect(0, 0, width, height);

            state.stack.forEach((block, i) => {
                const screenY = block.y + state.cameraY;
                if (screenY > height + CONFIG.BLOCK_HEIGHT || screenY < -CONFIG.BLOCK_HEIGHT * 2) return;
                drawBlock(block.x, screenY, block.width, block.height, i, false);
            });

            if (state.current && !state.current.placed) {
                const screenY = state.current.y + state.cameraY;
                drawBlock(state.current.x, screenY, state.current.width, state.current.height, state.stack.length, true);
            }

            state.falling.forEach(piece => {
                ctx.save();
                ctx.translate(piece.x, piece.y + state.cameraY + piece.height / 2);
                ctx.rotate(piece.rotation);
                ctx.globalAlpha = 0.85;
                const gradient = getGradient(ctx, piece.colorIndex, -piece.width / 2, -piece.height / 2, piece.width, piece.height);
                roundRect(ctx, -piece.width / 2, -piece.height / 2, piece.width, piece.height, CONFIG.BORDER_RADIUS);
                ctx.fillStyle = gradient;
                ctx.fill();
                ctx.restore();
            });
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        // ============================================================
        // GAME FLOW
        // ============================================================
        function startGame() {
            console.log('Starting game...');
            initAudio();

            state.playing = true;
            state.score = 0;
            state.combo = 0;
            state.maxCombo = 0;
            state.perfects = 0;
            state.speed = CONFIG.INITIAL_SPEED;
            state.cameraY = 0;
            state.targetCameraY = 0;
            state.falling = [];
            state.direction = 1;

            state.stack = [{
                x: centerX,
                y: baseY,
                width: CONFIG.INITIAL_WIDTH,
                height: CONFIG.BLOCK_HEIGHT,
                placed: true
            }];

            spawnNextBlock();
            updateUI();

            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('visible');
            document.getElementById('tapHint').style.display = 'block';
        }

        function gameOver() {
            state.playing = false;
            state.current = null;
            playSound('fail');

            const isNewRecord = state.score > state.highScore;
            if (isNewRecord) {
                state.highScore = state.score;
                localStorage.setItem('calveyStackHighScore', state.highScore.toString());
            }

            updateLeaderboard(state.score);
            drawTowerGraphic(state.score, state.highScore);
            updateUsernameDisplay();

            const quote = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            document.getElementById('quoteText').textContent = '"' + quote.text + '"';
            document.getElementById('quoteAuthor').textContent = '— ' + quote.author;

            document.getElementById('finalScore').textContent = state.score;
            document.getElementById('perfectCount').textContent = state.perfects;
            document.getElementById('bestCombo').textContent = state.maxCombo;
            
            const badge = document.getElementById('newRecordBadge');
            if (isNewRecord) {
                badge.classList.add('visible');
            } else {
                badge.classList.remove('visible');
            }

            document.getElementById('tapHint').style.display = 'none';

            setTimeout(() => {
                document.getElementById('gameOverScreen').classList.add('visible');
            }, 500);
        }

        // ============================================================
        // EVENT HANDLERS
        // ============================================================
        function handleGameTap(e) {
            if (e.target.closest('#soundToggle')) return;
            if (!state.playing) return;
            e.preventDefault();
            placeBlock();
        }

        // Start screen click
        document.getElementById('startScreen').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            startGame();
        });

        // Game tap during play
        document.getElementById('gameCanvas').addEventListener('click', handleGameTap);
        document.getElementById('gameCanvas').addEventListener('touchstart', function(e) {
            e.preventDefault();
            handleGameTap(e);
        });

        // Tap restart
        document.getElementById('tapRestart').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            startGame();
        });

        // Share score
        async function shareScore() {
            if (!state.username) {
                toast('Add your name first to post a score.');
                document.getElementById('usernameInput').focus();
                return;
            }

            if (state.score <= 0) {
                toast('Play a round first.');
                return;
            }

            // Ensure the score is posted (live when available; local fallback already updates).
            updateLeaderboard(state.score);

            const url = `${location.origin}${location.pathname}?share=1&name=${encodeURIComponent(state.username)}&score=${encodeURIComponent(state.score)}`;
            const text = `I scored ${state.score} in STACK. Can you beat me?`;

            try {
                if (navigator.share) {
                    await navigator.share({ title: 'STACK', text, url });
                } else {
                    await navigator.clipboard.writeText(url);
                    toast('Link copied. Share it with friends.');
                }
            } catch (e) {
                // user cancelled share
            }
        }

        document.getElementById('shareScoreBtn').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            shareScore();
        });

        // Also allow tapping anywhere on game over screen (except interactive elements)
        document.getElementById('gameOverScreen').addEventListener('click', function(e) {
            if (e.target.closest('.username-section')) return;
            if (e.target.closest('.leaderboard-section')) return;
            if (e.target.id === 'shareScoreBtn') return;
            if (e.target.id === 'tapRestart') return;
            startGame();
        });

        // Username handlers
        document.getElementById('saveUsernameBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            const input = document.getElementById('usernameInput');
            if (input.value.trim()) {
                saveUsername(input.value);
                updateLeaderboard(state.score);
            }
        });

        document.getElementById('usernameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const input = document.getElementById('usernameInput');
                if (input.value.trim()) {
                    saveUsername(input.value);
                    updateLeaderboard(state.score);
                }
            }
        });

        document.getElementById('usernameInput').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        document.getElementById('changeNameBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('usernameInputArea').classList.remove('hidden');
            document.getElementById('usernameDisplayArea').classList.add('hidden');
            document.getElementById('usernameInput').value = state.username;
            document.getElementById('usernameInput').focus();
        });

        // Sound toggle
        document.getElementById('soundBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            state.soundEnabled = !state.soundEnabled;
            this.classList.toggle('off', !state.soundEnabled);
            this.textContent = state.soundEnabled ? '♪' : '✕';
        });

        // ============================================================
        // INIT
        // ============================================================
        document.getElementById('highScoreValue').textContent = state.highScore;
        updateUsernameDisplay();

        // If someone opened a shared link, show a small hint.
        try {
            const params = new URLSearchParams(window.location.search);
            if (params.get('share') === '1') {
                const n = params.get('name') || 'A friend';
                const s = params.get('score') || '';
                toast(`${n} posted ${s}. Play and submit to beat it.`);
                // Clean up the URL so reloading doesn't repeat the toast.
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, '', cleanUrl);
            }
        } catch (e) {
            // ignore
        }

        loadGlobalLeaderboard();
        gameLoop();

        console.log('Game initialized');
    </script>
</body>
</html>


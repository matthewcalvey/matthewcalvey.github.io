<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>STACK - CALVEY INC.</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;600&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg: #0f0f13;
            --bg-lighter: #1a1a22;
            --bg-card: #1e1e28;
            --perfect: #ffd93d;
            --text: #ffffff;
            --text-dim: #5a5a6e;
            --text-quote: #9a9ab0;
            --border: #2a2a3e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%; height: 100%; overflow: hidden;
            background: var(--bg); font-family: 'IBM Plex Mono', monospace;
            -webkit-tap-highlight-color: transparent;
        }

        #gameContainer {
            width: 100%; height: 100%; position: relative; overflow: hidden;
            background: linear-gradient(180deg, var(--bg) 0%, var(--bg-lighter) 100%);
        }

        #gameContainer::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 40px 40px; pointer-events: none;
        }

        #scoreDisplay {
            position: absolute; top: 20px; left: 0; right: 0;
            text-align: center; z-index: 100; padding-top: 24px; pointer-events: none;
        }

        .score-label { font-size: 10px; font-weight: 500; letter-spacing: 0.35em; color: var(--text-dim); text-transform: uppercase; }
        .score-value { font-family: 'Bebas Neue', sans-serif; font-size: 80px; color: var(--text); line-height: 1; text-shadow: 0 4px 30px rgba(0,0,0,0.5); }
        .high-score { font-size: 11px; font-weight: 500; color: var(--text-dim); margin-top: 6px; letter-spacing: 0.1em; }

        #perfectIndicator {
            position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Bebas Neue', sans-serif; font-size: 56px; color: var(--perfect);
            text-shadow: 0 0 40px var(--perfect); opacity: 0; z-index: 200; pointer-events: none;
        }

        #perfectIndicator.show { animation: perfectPop 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes perfectPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.3); }
            30% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1) translateY(-40px); }
        }

        #comboDisplay {
            position: absolute; top: 43%; left: 50%; transform: translateX(-50%);
            font-size: 13px; font-weight: 600; letter-spacing: 0.25em; color: var(--perfect);
            opacity: 0; z-index: 200; transition: opacity 0.2s;
        }

        #comboDisplay.show { opacity: 1; }
        #gameCanvas { width: 100%; height: 100%; display: block; }

        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 500; background: var(--bg); cursor: pointer;
        }

        #startScreen.hidden { display: none; }
        .brand-logo { font-size: 11px; font-weight: 600; letter-spacing: 0.4em; color: var(--text-dim); margin-bottom: 20px; padding: 8px 16px; border: 1px solid var(--text-dim); border-radius: 4px; }
        .game-title { font-family: 'Bebas Neue', sans-serif; font-size: clamp(90px, 28vw, 160px); color: var(--text); letter-spacing: 0.08em; line-height: 1; }
        .tap-start { font-size: 13px; font-weight: 500; letter-spacing: 0.35em; color: var(--text); text-transform: uppercase; margin-top: 30px; animation: pulse 2s infinite; }

        #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500; background: rgba(15, 15, 19, 0.98); opacity: 0;
            pointer-events: none; transition: opacity 0.4s; overflow-y: auto;
        }

        #gameOverScreen.visible { opacity: 1; pointer-events: auto; }
        .game-over-wrapper { min-height: 100%; width: 100%; display: flex; flex-direction: column; align-items: center; text-align: center; padding: 40px 20px; }
        .final-score { font-family: 'Bebas Neue', sans-serif; font-size: 72px; color: var(--text); line-height: 1; }
        
        /* New Record styling */
        .new-record { font-size: 10px; font-weight: 600; color: var(--perfect); border: 2px solid var(--perfect); padding: 8px 20px; border-radius: 6px; margin: 15px 0; display: none; }
        .new-record.visible { display: block; }

        /* Username styling */
        .username-section { width: 100%; max-width: 300px; margin: 20px 0; }
        .username-input-wrapper { display: flex; gap: 8px; margin-top: 8px; }
        .username-input { flex: 1; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 10px; color: var(--text); font-family: inherit; }
        .username-save-btn { background: #764ba2; border: none; border-radius: 6px; padding: 0 15px; color: white; cursor: pointer; font-weight: 600; }
        
        /* Leaderboard styling */
        .leaderboard-section { width: 100%; max-width: 320px; margin-top: 20px; }
        .leaderboard-header { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .leaderboard-status { color: #43e97b; font-size: 9px; }
        .leaderboard { background: var(--bg-card); border-radius: 10px; overflow: hidden; border: 1px solid var(--border); }
        .leaderboard-entry { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border); }
        .leaderboard-entry.is-me { background: rgba(255, 217, 61, 0.05); }
        .entry-rank { font-family: 'Bebas Neue'; font-size: 18px; width: 30px; color: var(--text-dim); }
        .entry-name { flex: 1; text-align: left; font-size: 13px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .entry-score { font-family: 'Bebas Neue'; font-size: 20px; color: var(--perfect); }

        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="scoreDisplay">
            <div class="score-label">Score</div>
            <div class="score-value" id="scoreValue">0</div>
            <div class="high-score">Global Best: <span id="highScoreValue">0</span></div>
        </div>

        <div id="perfectIndicator">PERFECT</div>
        <div id="comboDisplay">√ó1 COMBO</div>

        <div id="startScreen">
            <div class="brand-logo">CALVEY INC.</div>
            <h1 class="game-title">STACK</h1>
            <p class="tap-start">Tap to Start Empire</p>
        </div>

        <div id="gameOverScreen">
            <div class="game-over-wrapper">
                <div class="final-score" id="finalScore">0</div>
                <div class="new-record" id="newRecordBadge">‚òÖ NEW WORLD RECORD ‚òÖ</div>
                
                <div class="username-section">
                    <div id="usernameInputArea">
                        <p style="font-size: 9px; color: var(--text-dim);">CLAIM YOUR RANK</p>
                        <div class="username-input-wrapper">
                            <input type="text" class="username-input" id="usernameInput" placeholder="Name" maxlength="12">
                            <button class="username-save-btn" id="saveUsernameBtn">OK</button>
                        </div>
                    </div>
                    <div id="usernameDisplayArea" class="hidden">
                        <p style="font-size: 12px; color: var(--text-quote);">Ranked as: <strong id="currentUsername" style="color: var(--text);"></strong></p>
                    </div>
                </div>

                <div class="leaderboard-section">
                    <div class="leaderboard-header">
                        <span>üèÜ Global Top 10</span>
                        <span class="leaderboard-status">LIVE</span>
                    </div>
                    <div class="leaderboard" id="leaderboard">
                        <div style="padding: 20px; color: var(--text-dim); font-size: 11px;">Syncing with cloud...</div>
                    </div>
                </div>
                
                <p class="tap-start" id="tapRestart" style="margin-top: 30px; cursor: pointer;">Tap to Try Again</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // FIREBASE CONFIGURATION (REPLACE THIS WITH YOUR OWN)
        // ============================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database ? firebase.database() : null;

        // ============================================================
        // GAME LOGIC
        // ============================================================
        const CONFIG = {
            BLOCK_HEIGHT: 32, INITIAL_WIDTH: 200, MIN_WIDTH: 20,
            INITIAL_SPEED: 3.5, SPEED_INCREMENT: 0.1, MAX_SPEED: 12,
            PERFECT_TOLERANCE: 7, CAMERA_LERP: 0.1, STACK_VISIBLE: 10
        };

        const GRADIENTS = [['#667eea', '#764ba2'], ['#f093fb', '#f5576c'], ['#4facfe', '#00f2fe'], ['#43e97b', '#38f9d7'], ['#fa709a', '#fee140']];

        const state = {
            playing: false, score: 0, globalBest: 0, combo: 0,
            current: null, stack: [], falling: [],
            cameraY: 0, targetCameraY: 0, direction: 1, speed: CONFIG.INITIAL_SPEED,
            username: localStorage.getItem('calveyUsername') || '',
            uid: localStorage.getItem('calveyUid') || 'u_' + Math.random().toString(36).substr(2, 9)
        };
        localStorage.setItem('calveyUid', state.uid);

        // ============================================================
        // WEB LEADERBOARD LOGIC
        // ============================================================
        function syncScore(score) {
            if (!db || !state.username) return;
            
            // Reference to this specific user's score in the global DB
            const userScoreRef = db.ref('leaderboard/' + state.uid);
            
            userScoreRef.once('value').then((snapshot) => {
                const currentDBScore = (snapshot.val() && snapshot.val().score) || 0;
                
                // Only update if new score is better
                if (score > currentDBScore) {
                    userScoreRef.set({
                        name: state.username,
                        score: score,
                        timestamp: Date.now()
                    });
                }
            });
        }

        function listenToLeaderboard() {
            if (!db) return;
            const topScoresRef = db.ref('leaderboard').orderByChild('score').limitToLast(10);
            
            topScoresRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const scores = [];
                for (let id in data) {
                    scores.push({ id, ...data[id] });
                }
                scores.sort((a, b) => b.score - a.score);
                
                if (scores.length > 0) {
                    state.globalBest = scores[0].score;
                    document.getElementById('highScoreValue').textContent = state.globalBest;
                }
                renderLeaderboardUI(scores);
            });
        }

        function renderLeaderboardUI(scores) {
            const container = document.getElementById('leaderboard');
            container.innerHTML = '';
            
            scores.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = `leaderboard-entry ${entry.id === state.uid ? 'is-me' : ''}`;
                div.innerHTML = `
                    <span class="entry-rank">#${index + 1}</span>
                    <span class="entry-name">${entry.name}</span>
                    <span class="entry-score">${entry.score}</span>
                `;
                container.appendChild(div);
            });
        }

        // ============================================================
        // ENGINE & RENDERING
        // ============================================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, baseY;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width * (window.devicePixelRatio || 1);
            canvas.height = height * (window.devicePixelRatio || 1);
            ctx.scale(window.devicePixelRatio || 1, window.devicePixelRatio || 1);
            centerX = width / 2;
            baseY = height * 0.75;
        }

        function drawBlock(x, y, w, h, index) {
            const colors = GRADIENTS[index % GRADIENTS.length];
            const grad = ctx.createLinearGradient(x - w/2, y, x + w/2, y + h);
            grad.addColorStop(0, colors[0]); grad.addColorStop(1, colors[1]);
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.roundRect(x - w / 2, y, w, h, 8);
            ctx.fill();
            
            if (w > 50) {
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.font = '600 9px IBM Plex Mono';
                ctx.textAlign = 'center';
                ctx.fillText('CALVEY INC.', x, y + h/2 + 3);
            }
        }

        function placeBlock() {
            const last = state.stack[state.stack.length - 1];
            const drift = state.current.x - last.x;
            const overlap = state.current.width - Math.abs(drift);

            if (overlap <= 0) return gameOver();

            if (Math.abs(drift) < CONFIG.PERFECT_TOLERANCE) {
                state.current.x = last.x;
                state.current.width = last.width;
                state.combo++;
                showPerfect();
            } else {
                state.current.width = overlap;
                state.current.x = drift > 0 ? last.x + (drift/2) + ( (last.width - overlap) / 2) : last.x + (drift/2) - ( (last.width - overlap) / 2);
                state.combo = 0;
            }

            state.current.placed = true;
            state.stack.push(state.current);
            state.score++;
            state.speed = Math.min(state.speed + CONFIG.SPEED_INCREMENT, CONFIG.MAX_SPEED);
            state.targetCameraY = Math.max(0, (state.stack.length - 5) * (CONFIG.BLOCK_HEIGHT + 4));
            
            spawnBlock();
            document.getElementById('scoreValue').textContent = state.score;
        }

        function spawnBlock() {
            const last = state.stack[state.stack.length - 1];
            state.current = {
                x: state.direction > 0 ? -100 : width + 100,
                y: last.y - CONFIG.BLOCK_HEIGHT - 4,
                width: last.width,
                placed: false
            };
            state.direction *= -1;
        }

        function showPerfect() {
            const el = document.getElementById('perfectIndicator');
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 700);
        }

        function gameOver() {
            state.playing = false;
            document.getElementById('finalScore').textContent = state.score;
            document.getElementById('gameOverScreen').classList.add('visible');
            
            if (state.score > state.globalBest) {
                document.getElementById('newRecordBadge').classList.add('visible');
            }
            
            if (state.username) syncScore(state.score);
        }

        function startGame() {
            state.stack = [{ x: centerX, y: baseY, width: CONFIG.INITIAL_WIDTH, placed: true }];
            state.score = 0;
            state.speed = CONFIG.INITIAL_SPEED;
            state.cameraY = 0; state.targetCameraY = 0;
            state.playing = true;
            document.getElementById('scoreValue').textContent = '0';
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('visible');
            spawnBlock();
        }

        // ============================================================
        // CORE LOOP
        // ============================================================
        function loop() {
            ctx.clearRect(0, 0, width, height);
            state.cameraY += (state.targetCameraY - state.cameraY) * CONFIG.CAMERA_LERP;

            if (state.playing) {
                state.current.x += state.speed * state.direction;
                if (state.current.x > width + 100 || state.current.x < -100) state.direction *= -1;
            }

            state.stack.forEach((b, i) => drawBlock(b.x, b.y + state.cameraY, b.width, CONFIG.BLOCK_HEIGHT, i));
            if (state.playing) drawBlock(state.current.x, state.current.y + state.cameraY, state.current.width, CONFIG.BLOCK_HEIGHT, state.stack.length);

            requestAnimationFrame(loop);
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        window.addEventListener('resize', resize);
        resize();

        const input = document.getElementById('usernameInput');
        const saveBtn = document.getElementById('saveUsernameBtn');

        saveBtn.addEventListener('click', () => {
            if (input.value.trim()) {
                state.username = input.value.trim();
                localStorage.setItem('calveyUsername', state.username);
                updateUserUI();
                if (state.score > 0) syncScore(state.score);
            }
        });

        function updateUserUI() {
            if (state.username) {
                document.getElementById('usernameInputArea').classList.add('hidden');
                document.getElementById('usernameDisplayArea').classList.remove('hidden');
                document.getElementById('currentUsername').textContent = state.username;
            }
        }

        // Handle Taps
        const handleInteraction = (e) => {
            if (!state.playing && !document.getElementById('gameOverScreen').classList.contains('visible')) {
                startGame();
            } else if (state.playing) {
                placeBlock();
            }
        };

        window.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                e.preventDefault();
                handleInteraction();
            }
        }, { passive: false });

        window.addEventListener('mousedown', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
                handleInteraction();
            }
        });

        document.getElementById('tapRestart').addEventListener('click', startGame);

        // Bootstrap
        updateUserUI();
        listenToLeaderboard();
        loop();

        // Migration: If they have a local high score from the old version, sync it!
        const oldScore = localStorage.getItem('calveyStackHighScore');
        if (oldScore && state.username) {
            syncScore(parseInt(oldScore));
        }
    </script>
</body>
</html>
